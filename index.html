<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reminiscence Sync | 朝花夕拾</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* --- 1. DESIGN SYSTEM VARIABLES --- */
        :root {
            --color-sumi: #1A1A1A;   /* Primary Text */
            --color-ishi: #666666;   /* Meta/Secondary */
            --color-kami: #F5F5F5;   /* Background */
            --color-gin:  #E0E0E0;   /* Borders */
            --color-hanko: #B22222;  /* Accent (Action) */
            
            --font-serif: 'Noto Serif TC', serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --space-unit: 1.5rem;
        }

        /* --- 2. BASE RESETS (The Anti-Pattern Enforcement) --- */
        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--color-kami);
            color: var(--color-sumi);
            font-family: var(--font-mono); /* Default to Logic */
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Noise Texture */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* Typography Override */
        h1, h2, h3 { font-family: var(--font-serif); font-weight: 700; letter-spacing: 0.05em; margin: 0; }
        input, textarea, button { font-family: var(--font-mono); border-radius: 0 !important; }

        /* --- 3. LAYOUT COMPONENTS --- */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 4rem 2rem;
            border-left: 1px dashed var(--color-gin);
            border-right: 1px dashed var(--color-gin);
            min-height: 100vh;
            background: var(--color-kami);
        }

        /* Header */
        header {
            margin-bottom: 4rem;
            border-bottom: 1px solid var(--color-sumi);
            padding-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .brand-title { font-size: 2.5rem; line-height: 1.2; }
        .brand-meta { color: var(--color-ishi); font-size: 0.8rem; margin-top: 0.5rem; display: block; }
        
        /* Interactive Elements */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            background: transparent;
            color: var(--color-sumi);
            border: 1px solid var(--color-sumi);
            padding: 0.8rem 1.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .btn:hover { background: var(--color-sumi); color: var(--color-kami); }
        
        .btn-primary { border-color: var(--color-hanko); color: var(--color-hanko); font-weight: bold; }
        .btn-primary:hover { background: var(--color-hanko); color: white; }

        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.75rem; }

        /* Inputs */
        .input-group { margin-bottom: 1.5rem; }
        label { display: block; font-size: 0.75rem; color: var(--color-ishi); margin-bottom: 0.5rem; text-transform: uppercase; }
        
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            background: #fff;
            border: 1px solid var(--color-gin);
            padding: 1rem;
            font-size: 0.9rem;
            color: var(--color-sumi);
            transition: border-color 0.2s;
        }
        
        input:focus, textarea:focus { border-color: var(--color-sumi); }
        textarea { resize: vertical; min-height: 200px; font-size: 0.85rem; line-height: 1.6; }

        /* Config Panel (Hidden) */
        #configPanel {
            display: none;
            background: #fff;
            border: 1px solid var(--color-sumi);
            padding: 2rem;
            margin-bottom: 3rem;
            position: relative;
        }
        #configPanel.active { display: block; animation: fadeIn 0.3s ease; }
        
        /* Preview Section */
        .card {
            border: 1px solid var(--color-gin);
            background: #fff;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .card-header { margin-bottom: 1.5rem; border-bottom: 1px dashed var(--color-gin); padding-bottom: 1rem; }
        .tag { 
            display: inline-block; 
            border: 1px solid var(--color-gin); 
            padding: 2px 8px; 
            font-size: 0.7rem; 
            margin-right: 5px; 
            color: var(--color-ishi);
        }

        /* Utility */
        .hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* SweetAlert Override to match theme */
        div:where(.swal2-container) div:where(.swal2-popup) {
            border-radius: 0 !important;
            border: 1px solid var(--color-sumi);
            font-family: var(--font-mono);
        }
        div:where(.swal2-icon) { border-color: var(--color-sumi) !important; color: var(--color-sumi) !important; }
        div:where(.swal2-styled.swal2-confirm) {
            border-radius: 0 !important;
            background-color: var(--color-sumi) !important;
        }
    </style>
</head>
<body>

<div class="container">
    
    <header>
        <div>
            <h1 class="brand-title">Knowledge<br>Sync_</h1>
            <span class="brand-meta">> System: GitHub Uploader Interface</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button onclick="toggleConfig()" class="btn btn-small">
                [::] Config
            </button>
            <button onclick="clearAll()" class="btn btn-small">
                // Reset
            </button>
        </div>
    </header>

    <div id="configPanel">
        <h3 style="margin-bottom: 1.5rem; font-size: 1.2rem;">> System Configuration</h3>
        <div class="input-group">
            <label>GitHub Personal Access Token (PAT)</label>
            <input type="password" id="ghToken" placeholder="ghp_xxxxxxxxxxxx">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="input-group">
                <label>Repository (owner/repo)</label>
                <input type="text" id="ghRepo" placeholder="username/repo">
            </div>
            <div class="input-group">
                <label>File Path (Folder)</label>
                <input type="text" id="ghPath" value="content/notes/">
            </div>
        </div>
        <div style="text-align: right;">
            <button onclick="saveConfig()" class="btn">Save Settings</button>
        </div>
    </div>

    <main>
        <div class="input-group">
            <label>Input Stream (Paste NotebookLM JSON)</label>
            <textarea id="jsonInput" placeholder='{ "source_metadata": { ... } }'></textarea>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem;">
            <span id="statusText" style="color: var(--color-ishi); font-size: 0.8rem;">Ready.</span>
            
            <div style="display: flex; gap: 15px;">
                <button onclick="previewData()" class="btn">
                    <i class="fa-regular fa-eye"></i> Preview
                </button>
                <button onclick="uploadToGitHub()" id="uploadBtn" class="btn btn-primary">
                    <i class="fa-brands fa-github"></i> Push to Repo
                </button>
            </div>
        </div>

        <div id="outputContainer" class="hidden">
            <h3 style="margin-bottom: 1rem; border-bottom: 1px solid var(--color-sumi); padding-bottom: 0.5rem;">> Data Preview</h3>
            <div id="previewContent"></div>
        </div>
    </main>

    <footer style="margin-top: 4rem; padding-top: 2rem; border-top: 1px dashed var(--color-gin); color: var(--color-ishi); font-size: 0.75rem;">
        /* © 2026 Reminiscence Studio. All rights reserved. */<br>
        Memory_Allocated: LocalStorage; Status: Stable;
    </footer>

</div>

<script>
    // --- 1. CONFIGURATION LOGIC ---
    function toggleConfig() {
        document.getElementById('configPanel').classList.toggle('active');
    }

    // Load saved config on startup
    window.onload = function() {
        document.getElementById('ghToken').value = localStorage.getItem('gh_token') || '';
        document.getElementById('ghRepo').value = localStorage.getItem('gh_repo') || '';
        document.getElementById('ghPath').value = localStorage.getItem('gh_path') || 'content/notes/';
    }

    function saveConfig() {
        const token = document.getElementById('ghToken').value.trim();
        const repo = document.getElementById('ghRepo').value.trim();
        const path = document.getElementById('ghPath').value.trim();

        if(!token || !repo) {
            Swal.fire({ title: 'Error', text: 'Token and Repo are required.', icon: 'error' });
            return;
        }

        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_repo', repo);
        localStorage.setItem('gh_path', path);
        
        Swal.fire({
            title: 'Saved',
            text: 'Configuration updated successfully.',
            icon: 'success',
            confirmButtonText: 'ACKNOWLEDGE'
        });
        toggleConfig();
    }

    // --- 2. UPLOAD LOGIC ---
    async function uploadToGitHub() {
        const rawJson = document.getElementById('jsonInput').value.trim();
        const btn = document.getElementById('uploadBtn');
        const status = document.getElementById('statusText');

        if (!rawJson) {
            Swal.fire({ title: 'Empty Input', text: 'Please paste JSON data first.', icon: 'warning' });
            return;
        }

        // Get Config
        const token = localStorage.getItem('gh_token');
        const repo = localStorage.getItem('gh_repo');
        let pathFolder = localStorage.getItem('gh_path') || 'content/';

        if (!token || !repo) {
            toggleConfig();
            Swal.fire({ title: 'Setup Required', text: 'Please configure GitHub settings.', icon: 'info' });
            return;
        }

        // Parse JSON
        let data;
        try {
            const cleanJson = rawJson.replace(/^```json/, '').replace(/```$/, '');
            data = JSON.parse(cleanJson);
        } catch (e) {
            Swal.fire({ title: 'Syntax Error', text: 'Invalid JSON format.', icon: 'error' });
            return;
        }

        // Prepare File
        const dateStr = new Date().toISOString().split('T')[0];
        const safeTitle = (data.source_metadata?.title || 'untitled')
            .toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        const fileName = `${dateStr}-${safeTitle}.json`;
        const fullPath = `${pathFolder.replace(/\/$/, '')}/${fileName}`;
        const apiUrl = `https://api.github.com/repos/${repo}/contents/${fullPath}`;
        
        // Encode content
        const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));

        // UI Loading State
        const originalText = btn.innerHTML;
        btn.innerHTML = '[ Uploading... ]';
        btn.disabled = true;
        status.innerText = 'Transmitting data to GitHub...';

        try {
            // Check existing file
            const checkRes = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
            let sha = null;
            if (checkRes.ok) {
                const fileData = await checkRes.json();
                sha = fileData.sha;
            }

            // PUT Request
            const putRes = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: `Sync: ${data.source_metadata?.title}`,
                    content: contentEncoded,
                    sha: sha
                })
            });

            if (putRes.ok) {
                const result = await putRes.json();
                status.innerText = 'Upload Complete.';
                Swal.fire({
                    title: 'Sync Complete',
                    html: `Data pushed to <a href="${result.content.html_url}" target="_blank" style="text-decoration:underline; font-weight:bold;">${fullPath}</a>`,
                    icon: 'success',
                    confirmButtonText: 'CLOSE'
                });
            } else {
                const err = await putRes.json();
                throw new Error(err.message);
            }

        } catch (error) {
            console.error(error);
            Swal.fire({ title: 'Upload Failed', text: error.message, icon: 'error' });
            status.innerText = 'Error occurred.';
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // --- 3. PREVIEW LOGIC ---
    function previewData() {
        const raw = document.getElementById('jsonInput').value.trim();
        if(!raw) return;

        try {
            const cleanJson = raw.replace(/^```json/, '').replace(/```$/, '');
            const data = JSON.parse(cleanJson);
            renderPreview(data);
            document.getElementById('outputContainer').classList.remove('hidden');
        } catch(e) {
            console.error(e);
        }
    }

    function renderPreview(data) {
        const container = document.getElementById('previewContent');
        const sections = data.sections || [];
        const meta = data.source_metadata || {};
        
        // Generate HTML string strictly following Design MD
        let html = `
            <div style="margin-bottom: 2rem; color: var(--color-ishi); font-size: 0.8rem;">
                METADATA: ${meta.title} | ${meta.main_author}
            </div>
        `;

        html += sections.map(sec => `
            <div class="card">
                <div class="card-header">
                    <h3 style="font-size: 1.5rem;">${sec.heading}</h3>
                    <div style="margin-top: 0.5rem;">
                        ${(sec.tags||[]).map(t => `<span class="tag">#${t}</span>`).join('')}
                    </div>
                </div>
                <p style="margin-bottom: 1.5rem; font-family: var(--font-serif); font-size: 1.1rem;">
                    ${sec.core_concept}
                </p>
                <div style="background: var(--color-kami); padding: 1rem; border: 1px dashed var(--color-gin);">
                    <div style="font-size: 0.75rem; color: var(--color-ishi); margin-bottom: 0.5rem;">ACTIONABLE_INSIGHTS</div>
                    <ul style="list-style: square; padding-left: 1.2rem; margin: 0;">
                        ${(sec.actionable_insights||[]).map(i => `<li>${i.content} <span style="font-size:0.7em">[Effort:${i.effort_score}]</span></li>`).join('')}
                    </ul>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    }

    function clearAll() {
        document.getElementById('jsonInput').value = '';
        document.getElementById('outputContainer').classList.add('hidden');
        document.getElementById('statusText').innerText = 'Ready.';
    }
</script>

</body>
</html>
